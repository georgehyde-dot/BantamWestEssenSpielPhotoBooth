# Development Dockerfile for running on x86_64 Linux
FROM rust:1.75-bookworm

ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    build-essential \
    pkg-config \
    libv4l-dev \
    libclang-dev \
    libcups2-dev \
    libssl-dev \
    libsqlite3-dev \
    # Image processing dependencies
    libimage-exiftool-perl \
    imagemagick \
    # Font dependencies for templates
    fonts-dejavu-core \
    fonts-liberation \
    # Development tools
    git \
    vim \
    tmux \
    htop \
    # Video/camera tools for testing
    v4l-utils \
    ffmpeg \
    # Printer tools
    cups \
    cups-client \
    cups-bsd \
    && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for hot reloading
RUN cargo install cargo-watch

# Set up working directory
WORKDIR /workspace

# Create directories for persistent data
RUN mkdir -p /usr/local/share/photo_booth/static && \
    mkdir -p /tmp/photo_booth

# Set environment variables for development
ENV RUST_LOG=info \
    RUST_BACKTRACE=1 \
    # Default configuration
    HOST=0.0.0.0 \
    PORT=8080 \
    VIDEO_DEVICE=/dev/video0 \
    VIDEO_WIDTH=1920 \
    VIDEO_HEIGHT=1080 \
    VIDEO_FORMAT=MJPG \
    STORAGE_PATH=/usr/local/share/photo_booth \
    DATABASE_PATH=/usr/local/share/photo_booth/photo_booth.db \
    USE_MOCK_PRINTER=true \
    PRINTER_NAME=Mock_Printer

# Expose the web server port
EXPOSE 8080

# Volume for source code (mounted from host)
VOLUME ["/workspace"]

# Volume for persistent data
VOLUME ["/usr/local/share/photo_booth"]

# Default command for development with hot reload
CMD ["cargo", "watch", "-x", "run"]
