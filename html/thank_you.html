<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Thanks for Visiting!</title>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Rye&family=Bebas+Neue&display=swap");

            body {
                margin: 0;
                padding: 0;
                font-family: "Rye", cursive;
                background-image: url("/static/interface_background.jpg");
                background-size: cover;
                background-position: center;
                background-repeat: no-repeat;
                background-attachment: fixed;
                color: #f4e4c1;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
                padding: 20px;
                box-sizing: border-box;
                overflow: hidden;
            }

            .container {
                animation: fadeIn 0.8s ease-out;
                width: 100%;
                max-width: 2200px;
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 60px;
                height: auto;
                max-height: 90vh;
                padding: 50px;
            }

            h1 {
                font-size: 8.5em;
                margin: 40px 0;
                text-align: center;
                color: #2c1810;
                text-shadow:
                    2px 2px 0px rgba(255, 255, 255, 0.3),
                    3px 3px 4px rgba(0, 0, 0, 0.2),
                    0 0 10px rgba(255, 255, 255, 0.2);
                letter-spacing: 2px;
                text-transform: uppercase;
                animation: fadeInDown 0.8s ease-out;
            }

            .subtitle {
                font-size: 5em;
                color: #2c1810;
                margin-bottom: 55px;
                text-shadow:
                    1px 1px 0px rgba(255, 255, 255, 0.3),
                    2px 2px 3px rgba(0, 0, 0, 0.2);
                font-family: "Bebas Neue", cursive;
                letter-spacing: 1px;
                animation: fadeIn 0.8s ease-out 0.2s both;
            }

            .left-side {
                flex: 1 1 60%;
                display: flex;
                align-items: center;
                justify-content: center;
                height: auto;
                animation: fadeInLeft 0.8s ease-out 0.2s both;
            }

            .right-side {
                flex: 1 1 40%;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 10px;
                animation: fadeInRight 0.8s ease-out 0.4s both;
            }

            .photo-container {
                position: relative;
                width: 100%;
                height: auto;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .final-photo {
                width: auto;
                height: auto;
                max-width: 100%;
                max-height: 95vh;
                object-fit: contain;
                border-radius: 10px;
                box-shadow:
                    0 8px 32px rgba(0, 0, 0, 0.8),
                    0 16px 64px rgba(0, 0, 0, 0.5);
                border: 4px solid #3d2914;
                background: #2a1810;
            }

            .photo-frame {
                position: absolute;
                top: -10px;
                right: -10px;
                bottom: -10px;
                left: -10px;
                border: 2px solid #d4af37;
                border-radius: 12px;
                pointer-events: none;
                opacity: 0.6;
            }

            .countdown-container {
                margin: 15px 0;
                font-family: "Bebas Neue", cursive;
                animation: fadeIn 0.8s ease-out 0.6s both;
                flex: 0 0 auto;
            }

            .countdown-text {
                font-size: 3.4em;
                color: #aaa;
                margin-bottom: 25px;
            }

            .countdown-timer {
                font-size: 5.8em;
                color: #d4af37;
                font-weight: bold;
                text-shadow:
                    2px 2px 4px rgba(0, 0, 0, 0.8),
                    0 0 15px rgba(212, 175, 55, 0.3);
            }

            .home-button {
                display: inline-block;
                padding: 42px 105px;
                font-size: 3.6em;
                background: linear-gradient(
                    135deg,
                    #3d2914 0%,
                    #5c3d28 50%,
                    #3d2914 100%
                );
                color: #f4e4c1;
                border: 3px solid #d4af37;
                border-radius: 10px;
                text-decoration: none;
                cursor: pointer;
                transition: all 0.3s ease;
                text-shadow:
                    2px 2px 0px #000,
                    3px 3px 6px rgba(0, 0, 0, 0.8);
                font-family: "Bebas Neue", cursive;
                letter-spacing: 2px;
                text-transform: uppercase;
                box-shadow:
                    0 4px 8px rgba(0, 0, 0, 0.6),
                    inset 0 -2px 4px rgba(0, 0, 0, 0.5);
                animation: fadeInUp 0.8s ease-out 0.8s both;
                margin-top: 10px;
            }

            .home-button:hover {
                transform: translateY(-3px) scale(1.05);
                box-shadow:
                    0 8px 16px rgba(0, 0, 0, 0.8),
                    inset 0 -2px 4px rgba(0, 0, 0, 0.5),
                    0 0 30px rgba(212, 175, 55, 0.3);
                background: linear-gradient(
                    135deg,
                    #4a3222 0%,
                    #6b4930 50%,
                    #4a3222 100%
                );
            }

            .home-button:active {
                transform: translateY(-1px) scale(1.02);
            }

            /* Western decorations */
            .star {
                position: absolute;
                font-size: 6em;
                color: #d4af37;
                opacity: 0.3;
                animation: twinkle 3s ease-in-out infinite;
            }

            .star-1 {
                top: 10%;
                left: 10%;
                animation-delay: 0s;
            }

            .star-2 {
                top: 15%;
                right: 15%;
                animation-delay: 1s;
            }

            .star-3 {
                bottom: 20%;
                left: 12%;
                animation-delay: 2s;
            }

            .star-4 {
                bottom: 15%;
                right: 10%;
                animation-delay: 0.5s;
            }

            @keyframes twinkle {
                0%,
                100% {
                    opacity: 0.3;
                    transform: scale(1);
                }
                50% {
                    opacity: 0.8;
                    transform: scale(1.2);
                }
            }

            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            @keyframes fadeInDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes fadeInLeft {
                from {
                    opacity: 0;
                    transform: translateX(-30px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            @keyframes fadeInRight {
                from {
                    opacity: 0;
                    transform: translateX(30px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            .loading-spinner {
                border: 12px solid #8b6635;
                border-top: 12px solid #f4e4c1;
                border-radius: 50%;
                width: 150px;
                height: 150px;
                animation: spin 1s linear infinite;
                margin: 50px auto;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Responsive adjustments */
            @media (max-width: 1024px) {
                .container {
                    flex-direction: column;
                    max-width: 800px;
                    gap: 20px;
                }
                .left-side {
                    flex: 0 1 auto;
                    height: 50vh;
                    width: 100%;
                }
                .right-side {
                    flex: 0 1 auto;
                    width: 100%;
                }
                .final-photo {
                    max-height: 45vh;
                }
            }

            /* Landscape mode on smaller screens */
            @media (max-height: 700px) and (orientation: landscape) {
                .container {
                    max-height: 95vh;
                    gap: 10px;
                    flex-direction: row;
                }
                .left-side {
                    flex: 1 1 65%;
                }
                .right-side {
                    flex: 1 1 35%;
                }
                h1 {
                    font-size: 6.5em;
                    margin: 30px 0;
                }
                .subtitle {
                    font-size: 4em;
                    margin-bottom: 40px;
                }
                .final-photo {
                    max-height: 85vh;
                }
                .countdown-container {
                    margin: 5px 0;
                }
                .countdown-timer {
                    font-size: 4.5em;
                }
                .home-button {
                    padding: 30px 75px;
                    font-size: 3em;
                    margin-top: 15px;
                }
            }

            @media (max-width: 600px) and (orientation: landscape) {
                .container {
                    flex-direction: row;
                    gap: 10px;
                }
                .left-side {
                    flex: 1 1 65%;
                }
                .right-side {
                    flex: 1 1 35%;
                }
                h1 {
                    font-size: 5.8em;
                    margin: 25px 0;
                }
                .subtitle {
                    font-size: 3.4em;
                    margin-bottom: 30px;
                }
                .final-photo {
                    max-height: 80vh;
                }
                .countdown-timer {
                    font-size: 4em;
                }
                .countdown-container {
                    margin: 5px 0;
                }
                .home-button {
                    font-size: 2.7em;
                    padding: 27px 60px;
                }
            }

            @media (max-width: 480px) {
                .container {
                    padding: 5px 0;
                    flex-direction: row;
                    gap: 10px;
                }
                .left-side {
                    flex: 1 1 60%;
                }
                .right-side {
                    flex: 1 1 40%;
                }
                h1 {
                    font-size: 4.8em;
                    margin: 25px 0;
                }
                .subtitle {
                    font-size: 2.7em;
                    margin-bottom: 25px;
                }
                .final-photo {
                    max-height: 70vh;
                }
                .countdown-text {
                    font-size: 2.4em;
                }
                .countdown-timer {
                    font-size: 3.3em;
                }
                .home-button {
                    font-size: 2.4em;
                    padding: 23px 53px;
                }
            }
        </style>
    </head>
    <body>
        <!-- Western star decorations -->
        <div class="star star-1">★</div>
        <div class="star star-2">★</div>
        <div class="star star-3">★</div>
        <div class="star star-4">★</div>

        <div class="container">
            <div class="left-side">
                <div class="photo-container">
                    <div class="photo-frame"></div>
                    <img
                        id="finalPhoto"
                        class="final-photo"
                        alt="Your Adventure"
                        style="display: none"
                    />
                    <div
                        id="loadingSpinner"
                        class="loading-spinner"
                        style="display: block"
                    ></div>
                </div>
            </div>

            <div class="right-side">
                <h1>Thanks for Visitin', Partner!</h1>
                <p class="subtitle">
                    Your adventure has been captured for eternity
                </p>

                <div class="countdown-container">
                    <div class="countdown-text">Returning to the trail in</div>
                    <div class="countdown-timer" id="countdown">60</div>
                </div>

                <button class="home-button" onclick="goHome()">
                    Start New Adventure
                </button>
            </div>
        </div>

        <script>
            let countdownValue = 60;
            let countdownInterval;
            const sessionId = sessionStorage.getItem("session_id");

            // Function to go back to start
            function goHome() {
                clearInterval(countdownInterval);
                sessionStorage.removeItem("session_id");
                sessionStorage.removeItem("captured_image");
                sessionStorage.removeItem("should_print");
                window.location.href = "/";
            }

            // Load and display the final templated image
            async function loadFinalImage() {
                console.log("=== THANK YOU PAGE - LOADING FINAL IMAGE ===");
                console.log("Session ID:", sessionId);

                const loadingSpinner =
                    document.getElementById("loadingSpinner");
                const finalPhoto = document.getElementById("finalPhoto");

                if (!sessionId) {
                    console.error("No session ID found, redirecting to home");
                    // If no session, go home immediately
                    goHome();
                    return;
                }

                console.log("Loading session data for ID:", sessionId);

                // Get the session data to load the templated image
                try {
                    console.log("Fetching session from: /session/" + sessionId);
                    const sessionResponse = await fetch(
                        `/session/${sessionId}`,
                    );
                    console.log(
                        "Session response status:",
                        sessionResponse.status,
                    );

                    if (sessionResponse.ok) {
                        const sessionData = await sessionResponse.json();
                        console.log("Session data received:", sessionData);

                        if (
                            sessionData.ok &&
                            sessionData.session &&
                            sessionData.session.photo_path
                        ) {
                            // Display the templated image from session
                            console.log("=== TEMPLATED IMAGE FOUND ===");
                            console.log(
                                "Photo path from session:",
                                sessionData.session.photo_path,
                            );
                            console.log("Session details:", {
                                id: sessionData.session.id,
                                group_name: sessionData.session.group_name,
                                email: sessionData.session.email,
                                photo_path: sessionData.session.photo_path,
                                story_text:
                                    sessionData.session.story_text?.substring(
                                        0,
                                        50,
                                    ) + "...",
                                headline: sessionData.session.headline,
                            });

                            const imagePath = `/images/${sessionData.session.photo_path}`;
                            console.log("Full image URL:", imagePath);
                            console.log("Setting image src and displaying...");

                            finalPhoto.src = imagePath;
                            finalPhoto.style.display = "block";
                            loadingSpinner.style.display = "none";

                            console.log(
                                "Image element updated, waiting for load...",
                            );
                        } else {
                            // No templated image available
                            console.error(
                                "=== NO TEMPLATED IMAGE IN SESSION ===",
                            );
                            console.error(
                                "Session data structure:",
                                sessionData,
                            );
                            console.error("Session OK?", sessionData.ok);
                            console.error(
                                "Session exists?",
                                !!sessionData.session,
                            );
                            console.error(
                                "Photo path exists?",
                                !!sessionData.session?.photo_path,
                            );

                            loadingSpinner.style.display = "none";
                            const container =
                                document.querySelector(".photo-container");
                            container.innerHTML =
                                '<p style="color: #d4af37; font-size: 1.2em;">Your adventure is complete!</p>';
                        }
                    } else {
                        console.error("=== FAILED TO LOAD SESSION ===");
                        console.error(
                            "Response status:",
                            sessionResponse.status,
                        );
                        console.error(
                            "Response text:",
                            await sessionResponse.text(),
                        );

                        loadingSpinner.style.display = "none";
                        const container =
                            document.querySelector(".photo-container");
                        container.innerHTML =
                            '<p style="color: #d4af37; font-size: 1.2em;">Your adventure is complete!</p>';
                    }
                } catch (error) {
                    console.error("=== EXCEPTION LOADING SESSION ===");
                    console.error("Error details:", error);
                    console.error("Stack trace:", error.stack);

                    loadingSpinner.style.display = "none";
                    const container =
                        document.querySelector(".photo-container");
                    container.innerHTML =
                        '<p style="color: #d4af37; font-size: 1.2em;">Your adventure is complete!</p>';
                }

                // Handle image load success
                finalPhoto.onload = function () {
                    console.log("=== IMAGE LOADED SUCCESSFULLY ===");
                    console.log(
                        "Image dimensions:",
                        this.naturalWidth,
                        "x",
                        this.naturalHeight,
                    );
                    console.log("Image src:", this.src);
                };

                // Handle image load error
                finalPhoto.onerror = function () {
                    console.error("=== FAILED TO LOAD TEMPLATED IMAGE ===");
                    console.error("Failed image src:", this.src);
                    console.error("Current session ID:", sessionId);

                    loadingSpinner.style.display = "none";
                    const container =
                        document.querySelector(".photo-container");
                    container.innerHTML =
                        '<p style="color: #d4af37; font-size: 1.2em;">Your photo is being processed...</p>';
                };
            }

            // Start countdown
            function startCountdown() {
                countdownInterval = setInterval(() => {
                    countdownValue--;
                    document.getElementById("countdown").textContent =
                        countdownValue;

                    if (countdownValue <= 0) {
                        goHome();
                    }
                }, 1000);
            }

            // Initialize page
            // Start loading final image and countdown when page loads
            window.addEventListener("DOMContentLoaded", function () {
                console.log("=== THANK YOU PAGE LOADED ===");
                console.log("URL:", window.location.href);
                console.log("Session ID from storage:", sessionId);
                console.log("Starting to load final image...");

                loadFinalImage();
                startCountdown();
            });
        </script>
    </body>
</html>
