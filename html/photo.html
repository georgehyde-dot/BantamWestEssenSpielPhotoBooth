<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Captured Photo</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0"
        />
        <style>
            :root {
                color-scheme: dark;
            }
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                background: #000;
                color: #fff;
                font-family:
                    system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Helvetica,
                    Arial,
                    sans-serif;
                margin: 0;
                height: 100vh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            #wrap {
                padding: 15px;
                text-align: center;
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: flex-start;
                overflow-y: auto;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #wrap.keyboard-open {
                padding-top: 10px;
                padding-bottom: 280px; /* Space for keyboard */
            }
            h1 {
                font-size: 2em;
                margin-bottom: 10px;
            }
            .photo-container {
                margin: 15px 0;
                max-width: min(70vw, 400px);
                width: 100%;
            }
            img.photo {
                background: #222;
                width: 100%;
                height: auto;
                max-height: 30vh;
                object-fit: contain;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
            }
            .email-section {
                margin: 20px 0;
                width: 100%;
                max-width: 500px;
            }
            .email-label {
                color: #aaa;
                font-size: 1em;
                margin-bottom: 10px;
                display: block;
            }
            .email-input {
                width: 100%;
                padding: 12px 18px;
                font-size: 18px;
                border: 2px solid #444;
                border-radius: 10px;
                background: #1a1a1a;
                color: #fff;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .email-input:focus,
            .email-input.active {
                outline: none;
                border-color: #0066cc;
                background: #222;
                transform: scale(1.02);
            }
            .email-input::placeholder {
                color: #666;
                font-style: italic;
            }
            .email-input.valid {
                border-color: #00cc66;
            }
            .email-input.invalid {
                border-color: #cc3333;
            }
            .actions {
                margin-top: 20px;
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
            }
            button,
            a.button {
                font-size: 16px;
                padding: 10px 20px;
                border-radius: 8px;
                border: 1px solid #666;
                background: #1f1f1f;
                color: #fff;
                cursor: pointer;
                text-decoration: none;
                display: inline-block;
                transition: all 0.3s ease;
            }
            button:hover:not(:disabled),
            a.button:hover {
                background: #2a2a2a;
                transform: translateY(-1px);
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            button.primary {
                background: #0066cc;
                border-color: #0066cc;
                font-weight: bold;
            }
            button.primary:hover:not(:disabled) {
                background: #0052a3;
            }
            button.success {
                background: #28a745;
                border-color: #28a745;
                font-weight: bold;
            }
            button.success:hover:not(:disabled) {
                background: #218838;
            }
            .error {
                color: #ff8080;
                margin: 16px 0;
            }
            .filename {
                color: #aaa;
                font-size: 0.8rem;
                margin: 5px 0;
                word-break: break-all;
            }

            /* Custom Keyboard Styles */
            .custom-keyboard {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(30, 30, 30, 0.98);
                backdrop-filter: blur(10px);
                border-top: 1px solid #444;
                padding: 10px 5px 15px;
                z-index: 1000;
                display: none;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
                animation: slideUp 0.3s ease-out;
                max-height: 280px;
            }
            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }
            .keyboard-row {
                display: flex;
                justify-content: center;
                margin: 4px 0;
                gap: 4px;
            }
            .key {
                background: #2a2a2a;
                border: 1px solid #444;
                border-radius: 6px;
                padding: 0;
                font-size: 16px;
                font-weight: 500;
                min-width: 32px;
                width: 32px;
                height: 42px;
                cursor: pointer;
                user-select: none;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.1s ease;
                color: #fff;
                flex: 1;
                max-width: 45px;
            }
            .key:active {
                background: #444;
                transform: scale(0.95);
            }
            .key.special {
                background: #1a1a1a;
                color: #aaa;
                font-weight: 600;
                font-size: 14px;
            }
            .key.special:active {
                background: #333;
            }
            .key.backspace {
                flex: 1.5;
                max-width: 65px;
            }
            .key.space {
                flex: 4;
                max-width: 140px;
            }
            .key.at-symbol {
                background: #2a4a6a;
                font-size: 18px;
                font-weight: bold;
            }
            .key.done {
                background: #0066cc;
                color: white;
                flex: 1.5;
                max-width: 70px;
            }
            .key.done:active {
                background: #0052a3;
            }
            .hidden {
                display: none !important;
            }

            /* Ensure no scrolling when keyboard is open */
            body.keyboard-active {
                overflow: hidden;
            }

            @media (max-width: 480px) {
                h1 {
                    font-size: 1.8em;
                }
                .photo-container {
                    max-width: min(80vw, 350px);
                }
                img.photo {
                    max-height: 25vh;
                }
                .key {
                    min-width: 28px;
                    width: 28px;
                    height: 38px;
                    font-size: 14px;
                    max-width: 40px;
                }
                .key.space {
                    max-width: 120px;
                }
                .custom-keyboard {
                    padding: 8px 3px 12px;
                    max-height: 250px;
                }
            }

            @media (max-height: 700px) {
                #wrap {
                    padding: 10px;
                }
                h1 {
                    font-size: 1.6em;
                    margin-bottom: 8px;
                }
                .photo-container {
                    margin: 10px 0;
                }
                img.photo {
                    max-height: 25vh;
                }
                .email-section {
                    margin: 15px 0;
                }
                .actions {
                    margin-top: 15px;
                }
            }
        </style>
    </head>
    <body>
        <div id="wrap">
            <h1>Your Adventure Photo</h1>
            <div id="filename" class="filename hidden"></div>
            <div id="error" class="error hidden"></div>

            <div class="photo-container">
                <img id="photo" class="photo" alt="Captured" hidden />
            </div>

            <div class="email-section">
                <label class="email-label" for="emailInput"
                    >Enter your email to receive your photo:</label
                >
                <input
                    type="text"
                    id="emailInput"
                    class="email-input"
                    placeholder="Tap to enter email"
                    readonly
                    autocomplete="off"
                />
            </div>

            <div class="actions">
                <a class="button" href="/camera">Retake Photo</a>
                <button
                    id="previewBtn"
                    class="button primary"
                    type="button"
                    disabled
                >
                    Preview Adventure
                </button>
                <button
                    id="printBtn"
                    class="button success"
                    type="button"
                    disabled
                >
                    Print Photo
                </button>
            </div>

            <noscript>
                <p class="error">
                    JavaScript is required to display the captured image.
                </p>
            </noscript>
        </div>

        <!-- Custom Keyboard -->
        <div id="customKeyboard" class="custom-keyboard">
            <div class="keyboard-row">
                <button type="button" class="key" data-key="q">q</button>
                <button type="button" class="key" data-key="w">w</button>
                <button type="button" class="key" data-key="e">e</button>
                <button type="button" class="key" data-key="r">r</button>
                <button type="button" class="key" data-key="t">t</button>
                <button type="button" class="key" data-key="y">y</button>
                <button type="button" class="key" data-key="u">u</button>
                <button type="button" class="key" data-key="i">i</button>
                <button type="button" class="key" data-key="o">o</button>
                <button type="button" class="key" data-key="p">p</button>
            </div>
            <div class="keyboard-row">
                <button type="button" class="key" data-key="a">a</button>
                <button type="button" class="key" data-key="s">s</button>
                <button type="button" class="key" data-key="d">d</button>
                <button type="button" class="key" data-key="f">f</button>
                <button type="button" class="key" data-key="g">g</button>
                <button type="button" class="key" data-key="h">h</button>
                <button type="button" class="key" data-key="j">j</button>
                <button type="button" class="key" data-key="k">k</button>
                <button type="button" class="key" data-key="l">l</button>
            </div>
            <div class="keyboard-row">
                <button type="button" class="key" data-key="z">z</button>
                <button type="button" class="key" data-key="x">x</button>
                <button type="button" class="key" data-key="c">c</button>
                <button type="button" class="key" data-key="v">v</button>
                <button type="button" class="key" data-key="b">b</button>
                <button type="button" class="key" data-key="n">n</button>
                <button type="button" class="key" data-key="m">m</button>
                <button
                    type="button"
                    class="key special backspace"
                    data-key="backspace"
                >
                    âŒ«
                </button>
            </div>
            <div class="keyboard-row">
                <button type="button" class="key" data-key=".">.</button>
                <button type="button" class="key at-symbol" data-key="@">
                    @
                </button>
                <button type="button" class="key space" data-key=" ">
                    space
                </button>
                <button type="button" class="key" data-key="_">_</button>
                <button type="button" class="key" data-key="-">-</button>
                <button type="button" class="key special done" data-key="done">
                    Done
                </button>
            </div>
        </div>

        <script>
            (function () {
                const params = new URL(window.location.href).searchParams;
                let file = params.get("file");
                const path = params.get("path");
                const sessionId = sessionStorage.getItem("session_id");

                if (!sessionId) {
                    window.location.href = "/";
                    return;
                }

                if (!file && path) {
                    // Accept `/images/<name></name>` or `<name></name>`
                    file = path.startsWith("/images/")
                        ? path.slice("/images/".length)
                        : path;
                }

                const isSafeName = (name) =>
                    /^[A-Za-z0-9._-]+$/.test(name || "");

                const photoEl = document.getElementById("photo");
                const errEl = document.getElementById("error");
                const nameEl = document.getElementById("filename");
                const emailInput = document.getElementById("emailInput");
                const previewBtn = document.getElementById("previewBtn");
                const printBtn = document.getElementById("printBtn");
                const keyboard = document.getElementById("customKeyboard");
                const wrap = document.getElementById("wrap");
                const body = document.body;

                // Email validation regex
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

                if (!file) {
                    errEl.textContent =
                        "No image specified. Expected ?file=<name>.jpg";
                    errEl.classList.remove("hidden");
                    return;
                }

                if (!isSafeName(file)) {
                    errEl.textContent =
                        "Invalid image name. Allowed characters: A-Z a-z 0-9 . _ -";
                    errEl.classList.remove("hidden");
                    return;
                }

                const src = "/images/" + encodeURIComponent(file);
                photoEl.src = src;
                photoEl.alt = "Captured: " + file;
                photoEl.removeAttribute("hidden");

                nameEl.textContent = file;
                nameEl.classList.remove("hidden");

                document.title = "Captured Photo - " + file;

                // Email input handling
                emailInput.addEventListener("click", function () {
                    this.classList.add("active");
                    keyboard.style.display = "block";
                    wrap.classList.add("keyboard-open");
                    body.classList.add("keyboard-active");

                    // Ensure email input is visible
                    setTimeout(() => {
                        const rect = this.getBoundingClientRect();
                        const keyboardHeight = 280;
                        const viewportHeight = window.innerHeight;

                        if (rect.bottom > viewportHeight - keyboardHeight) {
                            wrap.scrollTop +=
                                rect.bottom -
                                (viewportHeight - keyboardHeight) +
                                20;
                        }
                    }, 100);
                });

                // Keyboard handling
                document.querySelectorAll(".key").forEach((key) => {
                    key.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const keyValue = this.dataset.key;

                        switch (keyValue) {
                            case "backspace":
                                emailInput.value = emailInput.value.slice(
                                    0,
                                    -1,
                                );
                                break;
                            case "done":
                                closeKeyboard();
                                break;
                            default:
                                emailInput.value += keyValue;
                                break;
                        }

                        validateEmail();
                        emailInput.focus();
                    });
                });

                function closeKeyboard() {
                    keyboard.style.display = "none";
                    wrap.classList.remove("keyboard-open");
                    body.classList.remove("keyboard-active");
                    emailInput.classList.remove("active");
                }

                function validateEmail() {
                    const email = emailInput.value.trim();
                    const isValid = emailRegex.test(email);

                    emailInput.classList.remove("valid", "invalid");
                    if (email.length > 0) {
                        emailInput.classList.add(isValid ? "valid" : "invalid");
                    }

                    previewBtn.disabled = !isValid;
                    printBtn.disabled = !isValid;
                }

                // Print button handling
                printBtn.addEventListener("click", async () => {
                    const email = emailInput.value.trim();
                    if (!emailRegex.test(email)) {
                        alert("Please enter a valid email address");
                        return;
                    }

                    printBtn.disabled = true;
                    printBtn.textContent = "Printing...";

                    try {
                        // First get session data to retrieve copies
                        const sessionResponse = await fetch(
                            `/session/${sessionId}`,
                            {
                                method: "GET",
                            },
                        );

                        const sessionData = await sessionResponse.json();
                        const copies =
                            sessionData.ok && sessionData.session
                                ? sessionData.session.copies_printed || 1
                                : 1;

                        printBtn.textContent = `Printing ${copies} ${copies === 1 ? "copy" : "copies"}...`;

                        // Update session with email
                        const updateResponse = await fetch(
                            `/session/${sessionId}`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    email: email,
                                    photo_path: src,
                                }),
                            },
                        );

                        if (!updateResponse.ok) {
                            throw new Error("Failed to update session");
                        }

                        // Generate story based on selections before printing
                        printBtn.textContent = "Generating story...";
                        const storyResponse = await fetch(
                            `/session/${sessionId}/generate-story`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                            },
                        );

                        if (!storyResponse.ok) {
                            console.warn(
                                "Story generation failed, continuing with print anyway",
                            );
                        }

                        printBtn.textContent = `Printing ${copies} ${copies === 1 ? "copy" : "copies"}...`;

                        // Send print request
                        const printResponse = await fetch("/print", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                filename: file,
                                session_id: sessionId,
                                copies: copies,
                            }),
                        });

                        const result = await printResponse.json();

                        if (result.ok) {
                            // Save session to database before leaving
                            await fetch(`/session/${sessionId}/save`, {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                            });

                            // Redirect to wanted poster wall (session cleared there)
                            window.location.href = "/wanted_poster_wall";
                        } else {
                            alert(
                                "Print failed: " +
                                    (result.error || "Unknown error"),
                            );
                            printBtn.textContent = "Print Photo";
                            printBtn.disabled = false;
                        }
                    } catch (error) {
                        alert("Print failed: " + error.message);
                        printBtn.textContent = "Print Photo";
                        printBtn.disabled = false;
                    }
                });

                // Preview button handling
                previewBtn.addEventListener("click", async () => {
                    const email = emailInput.value.trim();
                    if (!emailRegex.test(email)) {
                        alert("Please enter a valid email address");
                        return;
                    }

                    previewBtn.disabled = true;
                    previewBtn.textContent = "Creating Preview...";

                    try {
                        // First update session with email
                        const sessionResponse = await fetch(
                            `/session/${sessionId}`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    email: email,
                                    photo_path: src,
                                }),
                            },
                        );

                        if (!sessionResponse.ok) {
                            throw new Error("Failed to update session");
                        }

                        // Generate story based on selections
                        const storyResponse = await fetch(
                            `/session/${sessionId}/generate-story`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                            },
                        );

                        // Proceed with preview even if story generation fails

                        // Now generate preview
                        previewBtn.textContent = "Generating...";
                        const previewResponse = await fetch("/preview", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                filename: file,
                                session_id: sessionId,
                            }),
                        });

                        const result = await previewResponse.json();

                        if (result.ok && result.preview_url) {
                            // Hide original photo and show preview
                            photoEl.style.display = "none";
                            emailInput.style.display = "none";
                            document.querySelector(
                                ".email-section",
                            ).style.display = "none";

                            // Create preview image element
                            const previewImg = document.createElement("img");
                            previewImg.src = result.preview_url;
                            previewImg.className = "photo";
                            previewImg.style.maxWidth = "100%";
                            previewImg.style.maxHeight = "60vh";
                            previewImg.alt = "Your adventure preview";

                            // Replace photo with preview
                            const photoContainer =
                                document.querySelector(".photo-container");
                            photoContainer.innerHTML = "";
                            photoContainer.appendChild(previewImg);

                            // Update title
                            const h1 = document.querySelector("h1");
                            h1.textContent = "Your Adventure is Ready!";

                            // Hide buttons and show return button
                            previewBtn.style.display = "none";
                            printBtn.style.display = "none";

                            // Update the back button
                            const backBtn = document.querySelector("a.button");
                            backBtn.textContent = "Start New Adventure";
                            backBtn.href = "/";
                            backBtn.addEventListener("click", function (e) {
                                e.preventDefault();
                                // Redirect to wanted poster wall (session cleared there)
                                window.location.href = "/wanted_poster_wall";
                            });

                            // Save session to database
                            const saveResponse = await fetch(
                                `/session/${sessionId}/save`,
                                {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                },
                            );

                            if (!saveResponse.ok) {
                                console.error(
                                    "Failed to save session to database",
                                );
                                previewBtn.textContent = "Preview Adventure";
                                previewBtn.disabled = false;
                            }
                        } else {
                            alert(
                                "Preview failed: " +
                                    (result.error || "Unknown error"),
                            );
                            previewBtn.textContent = "Preview Adventure";
                            previewBtn.disabled = false;
                        }
                    } catch (error) {
                        alert("Operation failed: " + error.message);
                        previewBtn.textContent = "Preview Adventure";
                        previewBtn.disabled = false;
                    }
                });

                // Close keyboard when clicking outside
                document.addEventListener("click", function (e) {
                    if (
                        !e.target.closest(".custom-keyboard") &&
                        !e.target.closest(".email-input") &&
                        emailInput.classList.contains("active")
                    ) {
                        closeKeyboard();
                    }
                });

                // If image fails to load, show an error
                photoEl.addEventListener("error", () => {
                    photoEl.setAttribute("hidden", "hidden");
                    previewBtn.style.display = "none";
                    printBtn.style.display = "none";
                    errEl.textContent = "Failed to load image: " + file;
                    errEl.classList.remove("hidden");
                });

                // Initialize
                validateEmail();
            })();
        </script>
    </body>
</html>
